// path: components/doc/data/workflowData.ts
import { WorkflowSection } from "../types/workflowTypes";

export const workflowSections: WorkflowSection[] = [
  {
    value: "architecture",
    icon: "Server",
    title: "System Architecture",
    subtitle: "Local-First, Sync & Performance",
    gradient: "from-slate-500 to-zinc-600",
    iconColor: "text-slate-400",
    bgGlow: "bg-slate-500/10",
    color: "yellow",
    purpose: "To explain the high-level architectural decisions that enable offline capability, high performance, and robust data synchronization.",
    workflows: [
      {
        title: "Architecture: Offline-First Data Sync",
        userSteps: [
          "User opens the application.",
          "Data is immediately available from the local database (IndexedDB).",
          "A background sync process fetches updates from the server in chunks.",
          "User performs actions (Create/Update/Delete) which are applied locally immediately.",
          "Changes are pushed to the server in the background.",
        ],
        uiSteps: [
          "The `SyncStatusIndicator` in the header shows 'Syncing...', 'Synced', or 'Offline'.",
          "Forms and Lists remain interactive even if the network is slow or disconnected.",
        ],
        techSteps: [
          "**Dexie.js** is used as the local IndexedDB wrapper.",
          "The `useDataSync` hook manages full-table synchronization using a **Batching Strategy** (fetching 2500 rows at a time via `get_paged_data` RPC) to prevent timeouts on large datasets like `ofc_connections`.",
          "The `useLocalFirstQuery` hook allows components to subscribe to live local data while triggering background network refreshes.",
          "Service Workers use `StaleWhileRevalidate` for navigation to ensure instant page loads.",
        ],
      },
      {
        title: "Architecture: Performance Optimizations",
        userSteps: ["User clicks 'Export to Excel' on a large table.", "User navigates between heavy pages."],
        uiSteps: ["The export starts without freezing the UI.", "Page navigation is instant."],
        techSteps: [
          "**Lazy Loading:** Heavy libraries like `ExcelJS` and `XLSX` are dynamically imported (`await import(...)`) only when the export/import action is triggered, reducing the initial bundle size.",
          "**Natural Sort:** Tables implement `Intl.Collator` with `{ numeric: true }` to correctly sort strings like 'Port 1', 'Port 2', 'Port 10'.",
          "**RPC Pagination:** All data fetching uses the `get_paged_data` PostgreSQL function to perform filtering, sorting, and pagination on the server-side for initial loads.",
        ],
      },
    ],
  },
  {
    value: "auth",
    icon: "ShieldCheck",
    title: "Authentication & RBAC",
    subtitle: "Security & User Management",
    gradient: "from-violet-500 to-purple-600",
    iconColor: "text-violet-400",
    bgGlow: "bg-violet-500/10",
    color: "violet",
    purpose: "To manage user identities, secure sessions, and enforce Role-Based Access Control (RBAC) across the application.",
    workflows: [
      {
        title: "Workflow: User Registration & Profile Creation",
        userSteps: [
          "User signs up via email/password or OAuth.",
          "User verifies email address.",
          "On first login, user is prompted to complete their profile via `OnboardingPromptModal`.",
        ],
        uiSteps: [
          "Redirects to `/verify-email` after signup.",
          "Redirects to `/dashboard` after login.",
          "Shows onboarding modal if `preferences->needsOnboarding` is true.",
        ],
        techSteps: [
          "The `on_auth_user_created` database trigger automatically creates a row in `public.user_profiles` whenever a user is added to `auth.users`.",
          "The `UserProvider` context wraps the application, fetching the extended profile (including role and permissions) and making it available globally.",
          "RBAC is enforced via `useUser().canAccess(allowedRoles)` checks in components and `Protected` route wrappers.",
        ],
      },
    ],
  },
  {
    value: "offline_first",
    icon: "Server",
    title: "Offline-First Architecture",
    subtitle: "Data Sync, Offline Queries & Mutation Queuing",
    gradient: "from-gray-500 to-slate-600",
    iconColor: "text-gray-400",
    bgGlow: "bg-gray-500/10",
    color: "yellow",
    purpose: "To provide a seamless and resilient user experience, allowing the application to function reliably even with intermittent or no network connectivity through a multi-layered caching and synchronization strategy.",
    workflows: [
      {
        title: "Workflow A: Initial Data Synchronization",
        userSteps: ["User logs in and lands on the main dashboard."],
        uiSteps: ["A toast notification appears: 'Starting data sync...'", "Once complete, the toast updates to 'Local data is up to date.'"],
        techSteps: [
          "The `DashboardContent` component calls the `useDataSync` hook, which triggers a `useQuery` to manage the sync process.",
          "It iterates through `entitiesToSync`, a list of table and view names.",
          "For each entity, the `syncEntity` function is called. It uses a dual strategy:",
          "- For **Views** (e.g., `v_rings`), it calls the `get_paged_data` RPC to bypass RLS issues and get complete, joined data.",
          "- For **Tables** (e.g., `user_profiles`), it uses a standard `supabase.from(...).select('*')`.",
          "The fetched data is written to the corresponding table in IndexedDB using Dexie's efficient `bulkPut` method.",
          "The local `sync_status` table is updated to track the progress of each entity.",
        ],
      },
      {
        title: "Workflow B: Offline Data Read (Example: Nodes Page)",
        userSteps: ["User goes offline.", "User navigates to the `/dashboard/nodes` page."],
        uiSteps: ["The page loads instantly with all the data.", "A toast appears: 'You are offline. Displaying locally cached data.'", "Searching and filtering the table is instantaneous."],
        techSteps: [
          "The `NodesPage` calls `useCrudManager`, which uses the `useNodesData` hook.",
          "`useNodesData` calls our custom `useOfflineQuery` hook.",
          "The `useOnlineStatus` hook inside `useOfflineQuery` returns `false`.",
          "`useOfflineQuery` immediately executes its `offlineQueryFn`, which fetches all records from the local Dexie table: `localDb.v_nodes_complete.toArray()`.",
          "All filtering (search) and pagination is then performed on this complete client-side dataset within a `useMemo` block.",
        ],
      },
      {
        title: "Workflow C: Offline Mutation & Queue Processing",
        userSteps: ["User is offline.", "User edits a Node's name via the `NodeFormModal` and clicks 'Update'."],
        uiSteps: ["The change appears instantly in the data table.", "A toast appears: 'Offline. Your change has been saved...'", "The header displays a 'Pending' sync indicator."],
        techSteps: [
          "The `useCrudManager`'s `handleSave` function detects `isOnline` is `false`.",
          "It performs an 'optimistic update' by writing the change directly to the local Dexie table: `getTable('nodes').update(...)`.",
          "It then calls `addMutationToQueue`, creating a new record in the `mutation_queue` table with the table name, action type, and payload.",
          "Later, the user comes back online. The `useOnlineStatus` hook updates.",
          "A `useEffect` inside the `useMutationQueue` hook (running in `DashboardContent`) detects the online status and pending tasks.",
          "The `processQueue` function retrieves the pending task, sends it to the real Supabase API, and on success, deletes the task from the local queue.",
          "Finally, it calls `queryClient.invalidateQueries()` to trigger a fresh data sync.",
        ],
      },
    ],
  },
  {
    value: "base_structure",
    icon: "Server",
    title: "Base Structure Setup",
    subtitle: "Categories, Lookups, Areas & Designations",
    gradient: "from-gray-500 to-slate-600",
    iconColor: "text-gray-400",
    bgGlow: "bg-gray-500/10",
    color: "yellow",
    purpose: "To configure the foundational data that categorizes and organizes all other entities in the system. This setup is typically performed by an administrator before regular data entry begins.",
    workflows: [
      {
        title: "Workflow A: Managing Categories & Lookups with System Flags",
        userSteps: [
          "Admin goes to `/dashboard/categories` and creates a new category (e.g., 'SYSTEM_TYPES').",
          "Admin navigates to `/dashboard/lookup`, selects the 'System Types' category, and clicks 'Add New'.",
          "In the `LookupModal`, admin fills in the details for a new system type.",
          "If the category is 'SYSTEM_TYPES', additional checkboxes appear: 'Is Ring-Based System' and 'Is SDH System'.",
          "Admin checks 'Is Ring-Based System' for types like 'CPAN' or 'MAAN'.",
          "Admin saves the new lookup type.",
        ],
        uiSteps: [
          "The Categories page allows creating and renaming high-level categories.",
          "On the Lookups page, a category must be selected to view or add types.",
          "The `LookupModal` conditionally displays checkboxes for `is_ring_based` and `is_sdh` only when the `category` is 'SYSTEM_TYPES'.",
        ],
        techSteps: [
          "A **Category** is a distinct value in the `category` column of the `lookup_types` table.",
          "When creating a new System via the `SystemModal`, the form fetches the selected `system_type_id`'s full record from `lookup_types`.",
          "The `upsert_system_with_details` database function receives all system parameters.",
          "Inside the function, it checks the boolean flags on the system type record (e.g., `IF v_system_type_record.is_ring_based = true THEN...`).",
          "Based on these flags, the function executes conditional `INSERT` or `UPDATE` statements on the appropriate subtype tables (e.g., `ring_based_systems`, `sdh_systems`).",
          "This flag-based approach makes the system extensible, as new system behaviors can be added just by adding a new boolean flag and a corresponding `IF` block in the function.",
        ],
      },
      {
        title: "Workflow B: Managing Maintenance Areas",
        userSteps: [
          "Admin navigates to `/dashboard/maintenance-areas`.",
          "Clicks 'Add New' and fills out the `AreaFormModal` to create a top-level area (e.g., a Zone).",
          "Admin then creates another area (e.g., a Terminal), but this time selects the newly created Zone as its 'Parent Area', establishing a hierarchy.",
        ],
        uiSteps: [
          "The `EntityManagementComponent` displays the areas in a hierarchical tree view or a simple list view.",
          "The form modal for an area dynamically filters the 'Parent Area' dropdown to prevent a user from making an area its own child (circular dependency).",
        ],
        techSteps: [
          "The page uses the `EntityManagementComponent` with `areaConfig`, which defines the parent-child relationship via the `parent_id` foreign key field.",
          "Data is fetched using `useTableWithRelations` to include nested `parent_area` and `child_areas` data in a single query.",
          "The `AreaFormModal` uses `useTableInsert` or `useTableUpdate` to modify records in the `maintenance_areas` table.",
        ],
      },
    ],
  },
  {
    value: 'designations_crud',
    icon: "ImUserTie",
    title: 'Designation Management',
    subtitle: 'Organizing employee roles in a hierarchy',
    gradient: 'from-cyan-500 to-sky-600',
    iconColor: 'text-cyan-400',
    bgGlow: 'bg-cyan-500/10',
    color: 'cyan',
    purpose: 'To establish a hierarchical structure for employee roles, enabling clear reporting lines and organizational charts. This feature is crucial for building an accurate representation of the company structure.',
    workflows: [
      {
        title: 'Workflow: Managing a Designation Hierarchy',
        userSteps: [
          "Admin navigates to `/dashboard/designations`.",
          "Clicks 'Add New Designation' to create a top-level role (e.g., 'General Manager') without selecting a parent.",
          "Clicks 'Add New' again to create a child role (e.g., 'Deputy Manager') and selects 'General Manager' from the 'Parent Designation' dropdown.",
          "User toggles between 'Tree' and 'List' view to visualize the structure.",
          "Admin clicks the 'Delete' icon on a role.",
        ],
        uiSteps: [
          'The `EntityManagementComponent` is the main layout, displaying designations in either a nested tree structure or a flat list.',
          'The `DesignationFormModal` appears for creating or editing. It intelligently filters the `Parent Designation` dropdown to prevent a designation from being its own child or grandchild (a circular dependency).',
          'A `ConfirmModal` appears before any deletion to ensure the action is intentional.',
        ],
        techSteps: [
          'The page is powered by the generic `EntityManagementComponent`, configured with `designationConfig`. This config object specifies `isHierarchical: true` and sets `parent_id` as the relational key.',
          'Data is fetched using the `useTableWithRelations` hook, which performs a self-join on the `employee_designations` table to get the `parent_designation` object for each record.',
          'The `useEntityManagement` hook processes the flat list into a nested tree structure for the UI by matching `id` and `parent_id` fields.',
          'When creating or editing, the `DesignationFormModal` uses the `useTableInsert` or `useTableUpdate` mutation to save data directly to the `employee_designations` table.',
          'The `useDelete` hook (via `useDeleteManager`) handles deletion by calling `supabase.from("employee_designations").delete()`. Postgres handles the `ON DELETE SET NULL` constraint for any children of the deleted designation.',
        ],
      },
    ],
  },
  {
    value: "employees_crud",
    icon: "BsPeople",
    title: "Employee Management",
    subtitle: "Managing employee records and roles",
    gradient: "from-sky-500 to-blue-600",
    iconColor: "text-sky-400",
    bgGlow: "bg-sky-500/10",
    color: "cyan",
    purpose: "To maintain a central database of all employees, their designations, contact information, and assigned maintenance areas.",
    workflows: [
      {
        title: "Workflow: Managing Employee Records",
        userSteps: ["Admin navigates to `/dashboard/employees`.", "Clicks 'Add New' to open the `EmployeeForm`.", "Fills in employee details, selecting a pre-configured Designation and Maintenance Area.", "Saves the new employee record."],
        uiSteps: ["The `DataTable` on the page lists all employees.", "The form modal provides dropdowns for selecting related data like designations.", "On success, a toast appears, and the employee list is refreshed."],
        techSteps: [
          "The page uses `useCrudManager` configured for the `employees` table.",
          "The `EmployeeForm` uses `useTableInsert` or `useTableUpdate` to save data to the `employees` table.",
          "The `employee_designation_id` and `maintenance_terminal_id` fields are foreign keys linking to their respective tables.",
          "The main data table queries the `v_employees` view to efficiently join and display the names of the designation and maintenance area.",
        ],
      },
    ],
  },
  {
    value: "diagrams_crud",
    icon: "FaDiagramNext",
    title: "Diagrams & File Management",
    subtitle: "Uploading and organizing network diagrams",
    gradient: "from-rose-500 to-pink-600",
    iconColor: "text-rose-400",
    bgGlow: "bg-rose-500/10",
    color: "orange",
    purpose: "To provide a centralized repository for uploading, storing, and accessing network diagrams, schematics, and other related documents.",
    workflows: [
      {
        title: "Workflow: Uploading a Diagram",
        userSteps: ["User navigates to the `/dashboard/diagrams` page.", "Creates a new folder or selects an existing one.", "Drags a file into the upload area or clicks 'Select Files'.", "Clicks the 'Upload' button."],
        uiSteps: ["The `FileUploader` component provides the main interface.", "A list of selected files appears before uploading.", "A success toast confirms the upload, and the file appears in the `FileTable` under the selected folder."],
        techSteps: [
          "The `useFolders` hook fetches and manages folder state from the `folders` table.",
          "The `useUppyUploader` hook handles the client-side file processing, including image optimizations via `smartCompress`.",
          "Uppy uploads the file to a serverless API route at `/api/upload`.",
          "The API route uploads the file to Supabase Storage.",
          "On `upload-success`, the `useUppyUploader` hook calls the `useUploadFile` mutation, which inserts a new record into the `files` table, linking the file metadata to the `folder_id` and `user_id`.",
        ],
      },
    ],
  },
  {
    value: "users_crud",
    icon: "Users",
    title: "User CRUD Operations",
    subtitle: "Creating, updating, and deleting users",
    gradient: "from-blue-500 to-cyan-600",
    iconColor: "text-blue-400",
    bgGlow: "bg-blue-500/10",
    color: "blue",
    purpose: "To provide administrators with the tools to manage user accounts, assign roles, and control access.",
    workflows: [
      {
        title: 'Workflow A: Viewing & Filtering Users',
        userSteps: [
          'Admin navigates to the `/dashboard/users` page.',
          'Admin uses the search bar and filter dropdowns to find specific users.',
        ],
        uiSteps: [
          'The `DataTable` displays a paginated list of users from the `v_user_profiles_extended` view.',
          'The `UserFilters` component updates the view as the admin types or selects filters.',
        ],
        techSteps: [
          'The `AdminUsersPage` uses a `useCrudManager` hook with a `useUsersData` adapter.',
          'The `useUsersData` adapter calls the `admin_get_all_users_extended` Supabase RPC.',
          'The RPC function performs a server-side search and filter on the `v_user_profiles_extended` view and returns the paginated results.',
        ],
      },
      {
        title: 'Workflow B: Creating a New User (Admin)',
        userSteps: [
          "Admin clicks 'Add New'.",
          "Fills in the user's details (name, email, password, role) in the `UserCreateModal`.",
          "Clicks 'Create User'.",
        ],
        uiSteps: [
          'The modal appears for data entry.',
          'On success, a toast notification is shown, the modal closes, and the user list refreshes.',
        ],
        techSteps: [
          'The `handleCreateUser` function calls the `createUser` mutation from `useAdminUserOperations` hook.',
          'This mutation sends a `POST` request to the `/api/admin/users` serverless function.',
          "THE FIX: The API route now only inserts into `auth.users`, passing the role and metadata.",
          'The `on_auth_user_created` database trigger is the single source of truth for profile creation. It reads the metadata and role from the new `auth.users` record and automatically inserts a corresponding row into `public.user_profiles`.',
          'The frontend invalidates the user list query to show the new user.',
        ],
      },
      {
        title: 'Workflow C: Editing a User',
        userSteps: [
          "Admin clicks the 'Edit' icon on a user row.",
          "Modifies user details (e.g., name, role, status) in the `UserProfileEditModal`.",
          "Clicks 'Save Changes'.",
        ],
        uiSteps: [
          'The modal opens, pre-filled with the selected userâ€™s data.',
          'On success, a toast is shown, and the UI updates with the new information.',
        ],
        techSteps: [
          'The `onEdit` handler from `useCrudManager` opens the modal with the user record.',
          'Submitting the form calls the `updateProfile` mutation from the `useAdminUpdateUserProfile` hook.',
          'This mutation calls the `admin_update_user_profile` RPC, which updates the `user_profiles` table.',
          'If the role is changed, the `sync_user_role_trigger` database trigger syncs the new role to the `auth.users` table.',
          'The user list query is invalidated and refetched.',
        ],
      },
      {
        title: 'Workflow D: Deleting a User',
        userSteps: [
          "Admin selects one or more users using the checkboxes.",
          "Clicks the 'Delete' button in the `BulkActions` toolbar.",
          "Confirms the deletion in the `ConfirmModal`.",
        ],
        uiSteps: [
          'A confirmation modal appears to prevent accidental deletion.',
          'On success, a toast is shown, and the user(s) are removed from the table.',
        ],
        techSteps: [
          'The `handleBulkDelete` function calls the `bulkDelete` mutation from `useAdminUserOperations`.',
          'This mutation sends a `DELETE` request to the `/api/admin/users` endpoint with the selected user IDs.',
          'The API route first verifies the requester is a super admin, then uses a privileged Supabase client to call `supabase.auth.admin.deleteUser()` for each ID.',
          'The `ON DELETE CASCADE` constraint on the `user_profiles` table automatically removes the corresponding profile.',
          'The user list query is invalidated to refresh the UI.',
        ],
      },
    ],
  },
  {
    value: "nodes_crud",
    icon: "Cpu",
    title: "Node CRUD Operations",
    subtitle: "Managing physical network locations",
    gradient: "from-emerald-500 to-teal-600",
    iconColor: "text-emerald-400",
    bgGlow: "bg-emerald-500/10",
    color: "teal",
    purpose: "To create, view, update, and delete network nodes, which represent physical sites like exchanges, BTS towers, or junction points.",
    workflows: [
      {
        title: "Workflow: Managing Node Records",
        userSteps: ["User navigates to the `/dashboard/nodes` page, clicks 'Add New' or 'Edit'.", "Fills out details in the `NodeFormModal`.", "Saves the record."],
        uiSteps: ["The `DataTable` displays a list of nodes from the `v_nodes_complete` view.", "A modal opens for data entry.", "A toast confirms success and the table refreshes."],
        techSteps: [
          "The `NodesPage` uses the `useCrudManager` hook for state and action management.",
          "The `NodeFormModal` is a 'dumb' component. It receives the `crudActions.handleSave` function as its `onSubmit` prop.",
          "The `handleSave` function, provided by `useCrudManager`, triggers either `useTableInsert` or `useTableUpdate` on the `nodes` table.",
          "TanStack Query invalidates the `v_nodes_complete` view query, causing the UI to refetch and display changes.",
        ],
      },
    ],
  },
  {
    value: "systems_crud",
    icon: "FaDiagramNext",
    title: "Network Systems",
    subtitle: "Equipment, Capacity & Rings",
    gradient: "from-blue-500 to-cyan-600",
    iconColor: "text-blue-400",
    bgGlow: "bg-blue-500/10",
    color: "blue",
    purpose: "To manage the physical and logical network equipment (Systems), their capacities, and their organization into Rings.",
    workflows: [
      {
        title: "Workflow: Creating a System with Capacity",
        userSteps: [
          "Admin navigates to `/dashboard/systems`.",
          "Clicks 'Add New' to open the `SystemModal`.",
          "Selects 'System Type' (e.g., SDH, CPAN).",
          "Selects 'Capacity' (e.g., STM-16, 10G).",
          "If the system type is 'Ring-Based', a second step appears to select the Ring.",
        ],
        uiSteps: [
          "The form dynamically shows/hides fields based on the selected `System Type` configuration.",
          "Capacity dropdown is populated from `lookup_types` where category is `SYSTEM_CAPACITY`.",
        ],
        techSteps: [
          "The `SystemModal` uses `react-hook-form` with a Zod schema that allows optional `ring_id` (handling empty strings).",
          "On submit, `upsert_system_with_details` RPC is called.",
          "This SQL function handles the transaction: inserting into `systems` table (including `system_capacity_id`) and updating `ring_based_systems` if applicable.",
        ],
      },
      {
        title: "Workflow: Ring Management",
        userSteps: [
          "Admin navigates to `/dashboard/ring-manager`.",
          "Creates a new Ring.",
          "Adds systems to the ring using the 'Add Systems' modal.",
          "Uses the 'Edit System in Ring' feature to change the order or set a Hub.",
        ],
        uiSteps: [
          "The `SystemRingModal` allows selecting multiple systems to add to a ring.",
          "The `EntityManagementComponent` displays the ring structure.",
        ],
        techSteps: [
          "The `update_ring_system_associations` RPC manages the Many-to-Many relationship in `ring_based_systems`.",
          "The `v_rings` view calculates `total_nodes` dynamically.",
        ],
      },
    ],
  },
  {
    value: "rings_crud",
    icon: "BellRing",
    title: "Ring CRUD Operations",
    subtitle: "Defining and managing logical network rings",
    gradient: "from-orange-500 to-amber-600",
    iconColor: "text-orange-400",
    bgGlow: "bg-orange-500/10",
    color: "orange",
    purpose: "To manage logical network rings, which group various systems together to form a resilient communication path.",
    workflows: [
      {
        title: "Workflow: Creating or Editing a Ring",
        userSteps: ["User navigates to `/dashboard/rings`, clicks 'Add New' or 'Edit'.", "Fills out the `RingModal`.", "Saves the record."],
        uiSteps: ["The `DataTable` lists all rings.", "A modal opens for data entry.", "A success toast appears and the table refreshes."],
        techSteps: [
          "THE FIX: The `RingsPage` now follows the standard pattern, using `useCrudManager`.",
          "The `RingModal` is a 'dumb' component that receives `crudActions.handleSave` as its `onSubmit` prop.",
          "The `handleSave` function triggers either `useTableInsert` or `useTableUpdate` on the `rings` table.",
          "The query for the `v_rings` view is invalidated, refreshing the UI.",
        ],
      },
      {
        title: "Workflow B: Associating Systems with a Ring",
        userSteps: ["User clicks the 'Manage Systems' icon on a ring row.", "In the `RingSystemsModal`, user moves systems from the 'Available' list to the 'Associated' list.", "User clicks 'Save Changes'."],
        uiSteps: ["A dual-listbox modal appears, showing systems in the same maintenance area.", "On success, a toast is shown, the modal closes, and the 'Total Nodes' count in the table updates."],
        techSteps: [
          "The `handleManageSystems` handler opens the `RingSystemsModal`.",
          "The modal fetches associated systems and available systems from the `v_systems_complete` view.",
          "Saving triggers the `updateMutation`, which calls the `update_ring_system_associations` RPC function.",
          "This RPC function deletes old associations and inserts the new list of system IDs into the `ring_based_systems` junction table.",
          "The `v_rings` view query is invalidated, causing the 'Total Nodes' count to update.",
        ],
      },
    ],
  },
  {
    value: "routes",
    icon: "Route",
    title: "OFC Route Manager",
    subtitle: "Topology, Splicing & Tracing",
    gradient: "from-teal-500 to-emerald-600",
    iconColor: "text-teal-400",
    bgGlow: "bg-teal-500/10",
    color: "teal",
    purpose: "To manage the physical Optical Fiber Cable (OFC) network, including physical routes, cable segments, junction closures (JCs), and fiber splicing.",
    workflows: [
      {
        title: "Workflow A: Defining Route Topology",
        userSteps: [
          "User creates an OFC Cable between two nodes (Start/End).",
          "User opens 'Route Visualization'.",
          "User adds 'Junction Closures' (JCs) at specific KM markers.",
        ],
        uiSteps: [
          "The `RouteVisualization` component renders a linear graph of the route.",
          "Adding a JC visually splits the cable.",
        ],
        techSteps: [
          "The `add_junction_closure` RPC inserts a record into `junction_closures`.",
          "**Critical Trigger:** A database trigger `manage_cable_segments` fires. It calls `recalculate_segments_for_cable`, which deletes old segments and creates new `cable_segments` records based on the new JC positions, ensuring data integrity.",
        ],
      },
      {
        title: "Workflow B: Fiber Splicing (Matrix)",
        userSteps: [
          "User selects a JC in the Route Manager.",
          "User selects an incoming fiber from Segment A.",
          "User selects an outgoing fiber from Segment B.",
          "User clicks 'Confirm Splice' or uses 'Auto-Splice' for bulk connections.",
        ],
        uiSteps: [
          "The `FiberSpliceManager` shows a visual interface for mapping fibers.",
          "Connected fibers are highlighted.",
        ],
        techSteps: [
          "The `get_jc_splicing_details` RPC fetches the complex relationship of segments and fibers at a specific node.",
          "The `manage_splice` RPC handles the insertion/deletion of `fiber_splices` records.",
          "The `auto_splice_straight_segments` RPC performs bulk 1:1 splicing logic on the server side.",
        ],
      },
      {
        title: "Workflow C: End-to-End Fiber Tracing",
        userSteps: [
          "User views a System Connection.",
          "Clicks 'Trace Path' on a specific fiber.",
          "A modal shows the complete path: System A -> Patch Cord -> Cable Segment 1 -> Splice -> Cable Segment 2 -> ... -> System B.",
        ],
        uiSteps: [
          "The `FiberTraceVisualizer` renders the path steps.",
          "It calculates orientation (Forward/Backward) for each segment.",
        ],
        techSteps: [
          "The `trace_fiber_path` RPC uses a **Recursive CTE (Common Table Expression)** to traverse the `fiber_splices` and `cable_segments` tables.",
          "It returns an ordered list of elements (Segments and Splices) with loss calculations.",
          "The `useSyncPathFromTrace` hook allows 'caching' this calculated path onto the logical connection record for quick access.",
        ],
      },
    ],
  },
  {
    value: "provisioning",
    icon: "GitBranch",
    title: "Service Provisioning",
    subtitle: "Logical Paths & Connections",
    gradient: "from-cyan-500 to-blue-600",
    iconColor: "text-cyan-400",
    bgGlow: "bg-cyan-500/10",
    color: "cyan",
    purpose: "To allocate specific fiber resources to active system connections (services).",
    workflows: [
      {
        title: "Workflow: Connection Provisioning",
        userSteps: [
          "User opens a System.",
          "Creates a new Connection (e.g., to another System).",
          "Opens 'Allocate Fibers'.",
          "Selects the physical cable and specific fiber strands for Tx/Rx.",
        ],
        uiSteps: [
          "The `SystemConnectionFormModal` handles the connection metadata.",
          "The `FiberAllocationModal` allows selecting fibers from available inventory.",
        ],
        techSteps: [
          "The `upsert_system_connection_with_details` RPC manages the connection record.",
          "The `provision_service_path` RPC links specific `ofc_connections` (fibers) to the `system_connection`. It updates the `system_id` and `fiber_role` columns on the fiber table to mark them as 'Occupied'.",
        ],
      },
    ],
  },
  {
    value: "base_structure_extended",
    icon: "Database", // Mapped to Lucide Server/Database
    title: "Base Data & Utilities",
    subtitle: "Lookups, Import/Export & KML",
    gradient: "from-orange-500 to-amber-600",
    iconColor: "text-orange-400",
    bgGlow: "bg-orange-500/10",
    color: "orange",
    purpose: "Tools for managing master data and external file integrations.",
    workflows: [
      {
        title: "Workflow: Excel Data Import",
        userSteps: [
          "User navigates to any data page (e.g., Systems, Cables).",
          "Opens 'Quick Actions' -> 'Upload Excel'.",
          "Selects a file and confirms.",
        ],
        uiSteps: [
          "A preview of the upload is processed.",
          "Validation errors are shown per row.",
          "Progress bar shows upload status.",
        ],
        techSteps: [
          "The `useExcelUpload` hook parses the file using `xlsx` (dynamically imported).",
          "It validates data against the schema defined in `constants/table-column-keys.ts`.",
          "It performs a bulk upsert to Supabase.",
          "Upon success, it invalidates the React Query cache to refresh the UI.",
        ],
      },
      {
        title: "Workflow: KML Map Visualization",
        userSteps: [
          "User navigates to KML Manager.",
          "Uploads a Google Earth KML/KMZ file.",
          "Clicks to view the map.",
        ],
        uiSteps: [
          "The map renders markers and lines defined in the KML.",
          "Clicking a marker shows metadata.",
        ],
        techSteps: [
          "Files are uploaded to **Vercel Blob Storage** via `/api/kml`.",
          "The client fetches the KML content, parses it into GeoJSON using `@mapbox/togeojson`.",
          "Leaflet renders the GeoJSON layer.",
        ],
      },
    ],
  },
]